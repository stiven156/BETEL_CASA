{% load formatos %}
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ producto.nombre }}</title>
  <style>
    :root{--bg:#f7f7f8;--card:#fff;--text:#0f0f10;--muted:#5f5f66;--line:#e6e6ea;--black:#000}
    body{margin:0;font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text)}
    a{color:inherit}
    .wrap{max-width:1100px;margin:0 auto;padding:22px}
    .top{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;align-items:center;gap:12px}
    .brand img{height:44px}
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px;margin-top:16px}
    .box{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px;box-shadow:0 6px 18px rgba(0,0,0,.06)}
    .gal{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    .gal img{width:100%;height:260px;object-fit:cover;border-radius:14px;cursor:zoom-in;background:#fff;border:1px solid var(--line)}
    .btn{display:inline-block;background:#000;color:#fff;text-decoration:none;padding:12px 14px;border-radius:12px;font-weight:800}
    select{width:100%;padding:10px;border:1px solid var(--line);border-radius:12px;background:#fff;color:#111}
    .muted{opacity:.9;font-size:12px;line-height:1.6;margin-top:10px;white-space:pre-line;color:var(--muted)}
    /* visor */
    .viewer-back{position:fixed;inset:0;background:rgba(0,0,0,.75);display:none;align-items:center;justify-content:center;z-index:9999}
    .viewer{max-width:92vw;max-height:92vh;overflow:hidden;border-radius:16px;border:1px solid #333;background:#111}
    .viewer img{max-width:92vw;max-height:92vh;transform-origin:center;cursor:zoom-in}
    .close{position:fixed;top:18px;right:18px;background:#fff;color:#000;border:none;border-radius:999px;padding:10px 12px;font-weight:800;cursor:pointer}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        {% if ajustes and ajustes.logo %}
        {% for image in product.images.all %}
    <img src="{{ image.image.url }}" alt="{{ product.name }}">
        {% endfor %}

        {% else %}
          <h2 style="margin:0;">{{ ajustes.nombre_marca|default:"Betel Casa de Dios" }}</h2>
        {% endif %}
      </div>
      <a href="{% url 'store:catalogo' %}">← Volver</a>
    </div>

    <div class="grid">
      <div class="box">
        <h1 style="margin:0 0 6px 0;">{{ producto.nombre }}</h1>
        <p style="margin:0;color:var(--muted);font-weight:700;">$ {{ producto.precio|cop }}</p>

        <div class="gal" style="margin-top:14px;">
          {% for f in fotos %}
            <img src="{{ f.imagen.url }}" alt="{{ producto.nombre }}" onclick="abrir('{{ f.imagen.url }}')">
          {% empty %}
            <p class="muted">Este producto aún no tiene fotos.</p>
          {% endfor %}
        </div>
        <p class="muted">Tip: toca la imagen para verla más grande y hacer zoom.</p>
      </div>

      <div class="box">
        <h3 style="margin-top:0;">Elige tu talla</h3>

        <select id="talla">
          {% for t in tallas %}
            <option value="{{ t.talla.nombre }}">{{ t.talla.nombre }} ({{ t.stock }})</option>
          {% empty %}
            <option value="">Sin stock</option>
          {% endfor %}
        </select>

        <p class="muted">
          Producción: {{ ajustes.dias_produccion|default:"3 días" }}<br>
          Envío: {{ ajustes.envio_tiempo|default:"3–5 días hábiles" }}<br>
          {{ ajustes.envio_nota|default:"" }}
        </p>

        <a id="btnwpp" class="btn" target="_blank" href="#">Comprar por WhatsApp</a>
      </div>
    </div>
  </div>

  <div id="back" class="viewer-back" onclick="cerrar(event)">
    <button class="close" onclick="cerrar(event)">Cerrar</button>
    <div class="viewer">
      <img id="imgBig" src="" alt="Zoom">
    </div>
  </div>

  <script>
    // WhatsApp con talla
    const btn = document.getElementById("btnwpp");
    const talla = document.getElementById("talla");
    const producto = "{{ producto.nombre|escapejs }}";
    const numero = "{% if ajustes %}{{ ajustes.whatsapp_numero }}{% else %}573001099123{% endif %}";

    function actualizar(){
      const t = talla.value || "";
      const msg = `Hola, quiero comprar: ${producto}. Talla: ${t}.`;
      btn.href = `https://wa.me/${numero}?text=${encodeURIComponent(msg)}`;
    }
    talla.addEventListener("change", actualizar);
    actualizar();

    // visor + zoom
    let zoom = 1;
    const back = document.getElementById("back");
    const imgBig = document.getElementById("imgBig");

    function abrir(url){
      zoom = 1;
      imgBig.style.transform = "scale(1)";
      imgBig.style.cursor = "zoom-in";
      imgBig.src = url;
      back.style.display = "flex";
    }
    function cerrar(e){
      if(e) e.stopPropagation();
      back.style.display = "none";
      imgBig.src = "";
    }
    imgBig.addEventListener("click", function(e){
      e.stopPropagation();
      zoom = (zoom === 1) ? 2 : 1;
      imgBig.style.transform = `scale(${zoom})`;
      imgBig.style.cursor = (zoom === 1) ? "zoom-in" : "zoom-out";
    });
  </script>
</body>
</html>
